<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Day 16 - Our Timeline</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Playfair+Display:ital,wght@0,400;1,700&display=swap" rel="stylesheet">
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; color: #fff; touch-action: none; }
        canvas { display: block; position: fixed; top: 0; left: 0; z-index: 1; }

        /* INTRO SEQUENCE */
        #intro-sequence {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 500; display: flex; flex-direction: column;
            justify-content: center; align-items: center; text-align: center;
            padding: 20px; box-sizing: border-box;
        }
        .text-container { position: relative; width: 100%; height: 120px; display: flex; justify-content: center; align-items: center; }
        .intro-text { font-family: 'Cinzel', serif; font-size: 1.1rem; letter-spacing: 3px; line-height: 1.8; position: absolute; opacity: 0; width: 90%; transition: opacity 1.5s ease; }
        #continue-btn { margin-top: 60px; padding: 12px 35px; border: 1px solid white; background: transparent; color: #fff; font-family: 'Cinzel', serif; letter-spacing: 4px; font-size: 0.8rem; cursor: pointer; opacity: 0; transition: 1s; z-index: 600; pointer-events: none; }

        /* UI LAYER */
        #ui-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 100; pointer-events: none; visibility: hidden; opacity: 0; transition: 2s;
        }

        #header { position: absolute; top: 40px; width: 100%; text-align: center; }
        .title { font-family: 'Cinzel', serif; font-size: 0.7rem; letter-spacing: 4px; opacity: 0.5; }
        .counter-display { font-family: 'Playfair Display', serif; font-size: 2.5rem; margin-top: 5px; }

        #center-container { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; text-align: center; }
        #echo-msg { font-family: 'Playfair Display', serif; font-style: italic; font-size: 1.1rem; opacity: 0; text-shadow: 0 0 20px #fff; }
        #hold-prompt { font-family: 'Cinzel', serif; font-size: 0.55rem; letter-spacing: 4px; color: rgba(255,255,255,0.4); margin-top: 10px; }

        /* HIGH-VISIBILITY BUTTONS */
        #controls-wrapper {
            position: fixed; bottom: 100px; left: 0; width: 100%;
            display: flex; flex-direction: column; align-items: center;
            pointer-events: auto; z-index: 1000;
        }
        #controls {
            display: flex; gap: 8px; background: rgba(255, 255, 255, 0.1);
            padding: 12px; border-radius: 40px; backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .btn {
            background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff; font-family: 'Cinzel', serif; padding: 10px 14px; font-size: 0.6rem;
            letter-spacing: 1px; border-radius: 20px; cursor: pointer;
        }
        .btn.active { background: #fff; color: #000; }
        #back-btn { margin-top: 15px; font-family: 'Cinzel', serif; font-size: 0.6rem; color: rgba(255,255,255,0.4); background: none; border: none; cursor: pointer; }
    </style>
</head>
<body>

<div id="intro-sequence">
    <div class="text-container">
        <div class="intro-text" id="t1">Baby,<br>We've been together for almost 7 months</div>
        <div class="intro-text" id="t2">It might not feel like a lot of time</div>
        <div class="intro-text" id="t3">But we've made so many memories,<br>time feels like just a number</div>
        <div class="intro-text" id="t4">See how long we've spent with each other.</div>
    </div>
    <button id="continue-btn">CONTINUE</button>
</div>

<div id="ui-layer">
    <div id="header">
        <div class="title" id="mode-label">OUR SHARED DAYS</div>
        <div class="counter-display" id="main-counter">0</div>
    </div>

    <div id="center-container">
        <div id="echo-msg">Hold the screen...</div>
        <div id="hold-prompt">HOLD TO FEEL THE TIME</div>
    </div>

    <div id="controls-wrapper">
        <div id="controls">
            <button class="btn active" onclick="setMode('days', this)">Days</button>
            <button class="btn" onclick="setMode('hours', this)">Hours</button>
            <button class="btn" onclick="setMode('minutes', this)">Minutes</button>
            <button class="btn" onclick="setMode('seconds', this)">Seconds</button>
        </div>
        <button id="back-btn" onclick="window.location.href='index.html'">BACK TO TIMELINE</button>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

<script>
    const startDate = new Date('2025-07-15T00:00:00');
    let scene, camera, renderer, starSystem, originalPositions, textTargets;
    let currentMode = 'days', isHolding = false;
    let animations = [];

    window.onload = () => {
        const sequence = [{id:"t1",d:4000}, {id:"t2",d:3500}, {id:"t3",d:5000}, {id:"t4",d:4000}];
        let delay = 1000;
        sequence.forEach((item, i) => {
            setTimeout(() => {
                document.getElementById(item.id).style.opacity = 1;
                setTimeout(() => { if(i < sequence.length-1) document.getElementById(item.id).style.opacity = 0; }, item.d - 1000);
            }, delay);
            delay += item.d;
        });
        setTimeout(() => { const b=document.getElementById('continue-btn'); b.style.opacity=1; b.style.pointerEvents='all'; }, delay - 800);
    };

    document.getElementById('continue-btn').onclick = function() {
        gsap.to("#intro-sequence", { opacity: 0, duration: 1, onComplete: () => {
            document.getElementById('intro-sequence').style.display = 'none';
            document.getElementById('ui-layer').style.visibility = 'visible';
            gsap.to("#ui-layer", { opacity: 1, duration: 1.5 });
            initThree();
            updateNumbers();
            setInterval(updateNumbers, 1000);
        }});
    };

    function initThree() {
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 2000);
        camera.position.z = 900;
        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);
        createStarField();
        animate();

        window.addEventListener('touchstart', (e) => { if(e.target.tagName !== 'BUTTON') { e.preventDefault(); startGravity(); } }, {passive: false});
        window.addEventListener('touchend', (e) => { if(e.target.tagName !== 'BUTTON') { e.preventDefault(); triggerBoom(); } }, {passive: false});
    }

    function createStarField() {
        if (starSystem) scene.remove(starSystem);
        let count = currentMode === 'days' ? 1500 : (currentMode === 'hours' ? 3000 : (currentMode === 'minutes' ? 5000 : 8000));
        const geo = new THREE.BufferGeometry();
        originalPositions = new Float32Array(count * 3);
        textTargets = new Float32Array(count * 3);

        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 800; canvas.height = 800;
        ctx.fillStyle = 'white';
        ctx.font = 'bold 100px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        
        const words = { days:["ALWAYS"], hours:["FOREVER"], minutes:["TILL THE", "END"], seconds:["YOUR", "SPIDEY"] };
        const lines = words[currentMode];
        const lh = 120;
        const startY = 400 - (((lines.length-1)*lh)/2);
        lines.forEach((line, i) => ctx.fillText(line, 400, startY + (i*lh)));
        
        const imgData = ctx.getImageData(0,0,800,800).data;
        const points = [];
        for(let y=0; y<800; y+=5) {
            for(let x=0; x<800; x+=5) {
                if(imgData[(y*800+x)*4]>128) points.push({x:(x-400)*1.8, y:(400-y)*1.8});
            }
        }

        for(let i=0; i<count*3; i+=3) {
            originalPositions[i] = (Math.random()-0.5)*2200;
            originalPositions[i+1] = (Math.random()-0.5)*2200;
            originalPositions[i+2] = (Math.random()-0.5)*2200;
            const target = points[Math.floor(Math.random()*points.length)] || {x:0, y:0};
            textTargets[i] = target.x;
            textTargets[i+1] = target.y;
            textTargets[i+2] = (Math.random()-0.5)*10;
        }

        geo.setAttribute('position', new THREE.BufferAttribute(new Float32Array(originalPositions), 3));
        starSystem = new THREE.Points(geo, new THREE.PointsMaterial({
            color: currentMode==='days'?0xFFD700:(currentMode==='hours'?0xFFA07A:0xffffff),
            size: 2, transparent: true, opacity: 0.8, blending: THREE.AdditiveBlending
        }));
        scene.add(starSystem);
    }

    function setMode(mode, el) {
        if (currentMode === mode || isHolding) return;
        currentMode = mode;
        document.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
        el.classList.add('active');
        document.getElementById('mode-label').innerText = `OUR SHARED ${mode.toUpperCase()}`;
        createStarField();
    }

    function startGravity() {
        isHolding = true;
        animations.forEach(a => a.kill());
        animations = [];
        const pos = starSystem.geometry.attributes.position.array;
        for (let i = 0; i < pos.length; i += 3) {
            animations.push(gsap.to(pos, { [i]: textTargets[i], [i+1]: textTargets[i+1], [i+2]: textTargets[i+2], duration: 2.2, ease: "power2.inOut" }));
        }
        gsap.to("#echo-msg", { opacity: 1, duration: 0.8 });
    }

    function triggerBoom() {
        if (!isHolding) return;
        isHolding = false;
        animations.forEach(a => a.kill());
        const pos = starSystem.geometry.attributes.position.array;
        
        const msgs = {
            days: ["Always yours.", "A gallery of sunrises we faced."],
            hours: ["Forever and a day.", "Every hour felt like a dream."],
            minutes: ["Till the end of time.", "Our small world."],
            seconds: ["Your Spidey, always.", "One second was all it took."]
        };
        const list = msgs[currentMode];
        const echo = document.getElementById('echo-msg');
        echo.innerText = list[Math.floor(Math.random()*list.length)];

        for (let i = 0; i < pos.length; i += 3) {
            gsap.to(pos, { [i]: originalPositions[i], [i+1]: originalPositions[i+1], [i+2]: originalPositions[i+2], duration: 1.2, ease: "expo.out" });
        }
        gsap.to("#echo-msg", { opacity: 0, duration: 1, delay: 2.5 });
    }

    function updateNumbers() {
        const diff = new Date() - startDate;
        let count = Math.floor(diff / (currentMode==='days'?86400000:currentMode==='hours'?3600000:currentMode==='minutes'?60000:1000));
        document.getElementById('main-counter').innerText = count.toLocaleString();
    }

    function animate() {
        requestAnimationFrame(animate);
        if (starSystem) {
            // FIXED: Only rotate when NOT holding. Text stays still when combined.
            if (!isHolding) {
                starSystem.rotation.y += 0.0006;
            } else {
                const pos = starSystem.geometry.attributes.position.array;
                for (let i = 0; i < pos.length; i++) pos[i] += (Math.random() - 0.5) * 1.5;
            }
            starSystem.geometry.attributes.position.needsUpdate = true;
        }
        renderer.render(scene, camera);
    }
</script>
</body>
</html>
